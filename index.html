<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sankey's Flashcards</title>
  <meta name="description" content="Turn any spreadsheet into my favorite memorization technique.">
  <meta name="author"      content="Jack C. Sankey">

  <style>

    body {
      display: flex;
      flex-direction: column;
      padding: 0;
      margin: 0;
      height: 100%;
      font-family: 'Times New Roman', Times, serif;
      color:Red;
      font-size: 1.4em;
    }

    .top_controls, .bottom_controls {
      display: flex;
      flex-direction: row;
      padding-left: 3.5px;
      padding-right: 3.5px;
    }

    .score {
      padding-left: 0.2em;
      font-weight: normal;
      border: solid #0774 1px; 
      color:#077; 
      font-size: 1.0em; 
      background-color: #00777707; 
      flex-grow: 1;
    }

    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .question, .answer {
      flex-grow: 1;
      text-align: center;
      font-size: 2.0em;
      margin-left: 7px;
      margin-right: 7px;
      background-color: white;
    }
    .question {
      margin-bottom: 7px;
      border: solid #00F4 1px;
      color:blue;
      background-color: #0000FF07;
    }
    .answer {
      margin-top: 0;

      border: solid #F004 1px;
      color:red;
      background-color: #FF000007;
    }

    .center {
      margin: 0;
      position: relative;
      top: 50%;
      -ms-transform: translateY(-50%);
      transform: translateY(-50%);
    }

    .control {
      flex-grow: 1;
    }

    button, select{
      background-color:white;
      color: rgb(150, 150, 150);
      border: solid rgb(197, 197, 197) 1px;
      padding: 0.3em;
      padding-left: 0.4em;
      padding-right: 0.4em; 
      display: inline-block;
      font-size: 0.8em;
      margin: 7px 3.5px;
      cursor: pointer;
      font-family: 'Times New Roman', Times, serif;
      font-weight: bold;
    }
    .voice {
      margin-left: 7px;
      margin-right: 7px;
      margin-bottom: -1px;
      margin-top: 0;
      font-size: 0.8em;
      font-weight: normal;
    }

  </style>

</head>

<body>

  <div class='bottom_controls'>
    <select onchange='load_cards();' id='select-sheet' style='margin-bottom:0; flex-grow: 1;'></select>
    <button onclick='shuffle_cards();' style='margin-bottom:0'>Shuffle</button>
    <button onclick='flip_cards();' style='margin-bottom:0'>Flip</button>
    <button onclick='edit();' style='margin-bottom:0'>Edit</button>
  </div>
  <div class='top_controls'>
    <button id='score'     class='score' onclick='set_score(0);'    >Score: 0</button>
    <button id='remaining' class='score' onclick='set_remaining();' >Remaining: 0</button>
  </div>
  
  <div class='content'>  

    <div><select id='select-qvoice' onchange='change_qvoice();' class='question voice'></select></div>
    <div onclick='show_question()' class='question'>
      <div id='div-question' class='center'>Loading...</div>
    </div>
    
    <div><select id='select-avoice' onchange='change_avoice();' class='answer voice'></select></div>
    <div onclick='show_answer()' class='answer'  >
      <div id='div-answer'   class='center'>&nbsp;</div>
    </div>
  </div>

  <div class='bottom_controls'>
    <button onclick='send_card_to(1,1);'  class='control' style='border: solid #F004 1px; color:red'>Redo</button>
    <button onclick='send_card_to(2,3);'  class='control' style='border: solid #F074 1px; color:#F07'>2-3</button>
    <button onclick='send_card_to(4,7);'  class='control' style='border: solid #B0F4 1px; color:#B0F'>4-7</button>
    <button onclick='send_card_to(-1);'   class='control' style='border: solid #70F4 1px; color:#70F'>???</button>
    <button onclick='send_card_to(null);' class='control' style='border: solid #00F4 1px; color:blue'>Done</button>
  </div>


  <script src='tabletop.min.js'></script>
  <script type='text/javascript'>    
    
    var url = window.location.search; 
    url = url.substr(1, url.length);
    console.log(url);
    if(url.substr(0,8) != 'https://') url = 'https://docs.google.com/spreadsheets/d/'+url+'/edit?usp=sharing';
    console.log(url);

    var sheets;
    var cards=[];
    var score=0;
    var cards_remaining=0; // Number of not-"done" cards remaining.
    var reverse=false;
    var select_qvoice = document.getElementById('select-qvoice');
    var select_avoice = document.getElementById('select-avoice');

    // Add the "No voice" entry
    o = document.createElement('option'); o.text = 'Silent'; select_qvoice.add(o);
    o = document.createElement('option'); o.text = 'Silent'; select_avoice.add(o);
    var langs = [];
    
    // Check for language support
    if(speechSynthesis) {
      langs = ["de-DE", "en-US", "en-GB", "es-ES", "es-US", "fr-FR", "hi-IN", "id-ID", "it-IT", "ja-JP", "ko-KR", "nl-NL", "pl-PL", "pt-BR", "ru-RU", "zh-CN", "zh-HK", "zh-TW"];
      for(var k in langs) {
        o = document.createElement('option'); o.text = langs[k]; select_qvoice.add(o);
        o = document.createElement('option'); o.text = langs[k]; select_avoice.add(o);
      }
      
      // Load the cookie
      var x = load_cookie('select_qvoice'); if(x) select_qvoice.value = x;
      x     = load_cookie('select_avoice'); if(x) select_avoice.value = x;
    }

    // Goes to the sheet to edit
    function edit() {location.href=url;}

    // Saves a cookie
    function save_cookie(key, value, expire_days) { console.log('save_cookie()', key, value);
        if(expire_days==undefined) expire_days=28;

        // get the expiration date
        var d = new Date();
        d.setTime(d.getTime() + (expire_days*24*60*60*1000));
        
        // now write the cookie string
        document.cookie = "Sankey_Flashcards_"+key + '=' + value + '; expires=' + d.toUTCString() + '; SameSite=Lax';
    }

    // Returns the cookie value or undefined
    function load_cookie(key) {
        
        // get a list of the cookie elements
        var cs = document.cookie.split(';');

        // Default is empty string
        var value = null;

        // Loop over elements to find the key
        for(var i=0; i<cs.length; i++) {

            // split by "=" sign
            s = cs[i].split('=');

            // strip white space
            while (s[0].charAt(0)==' ') s[0] = s[0].substring(1);

            // If it's our key
            if(s[0] == 'Sankey_Flashcards_'+key) {
                value = s[1];
                break;
            };
        }

        console.log('load_cookie()', key, value);
        return value;
    }

    function init() {
      Tabletop.init( { key: url, callback: load_data}); //, simpleSheet: true } );
    }

    // Just converts the format to a list of 2-element lists, one for each card
    function load_data(d, t) { 
      
      // Keep the sheets data for global use.
      sheets = d; 
      console.log(sheets);
      
      // Get the select object
      var s = document.getElementById('select-sheet');
      
      // Add the new elements
      var ks = [];
      for(var k in sheets) {
        ks.push(k);
        console.log(' ', k);
        var o = document.createElement('option');
        o.text = k;
        s.add(o);
      }
      
      // Load the cookie if it's there and set the selection
      var c = load_cookie('select_sheet');
      console.log('  last sheet', c, ks);
      if(c != null && ks.includes(c)) {
        console.log('  setting', c);
        s.value = c;
      }
    
      // Also save the cookie so it stays at the original (sometimes the sheets come in reverse order!)
      save_cookie('select_sheet', s.value);

      // Load the cards for this value
      load_cards();

      // If we're reversed, do this
      if(load_cookie('reverse') == 'true') flip_cards();
    }

    function load_cards() {

      // Get the sheet key
      var s = document.getElementById('select-sheet'); 
      save_cookie('select_sheet', s.value);
      
      // Get the data for this sheet
      var d = sheets[s.value].elements;
      console.log('load_cards()', s.value, d.length);

      // If there is no deck
      if(!d.length) {
        document.getElementById('div-question').innerHTML = 'No cards?';
        return
      }
      
      // Get the column keys from this sheet.
      var qkey = Object.keys(d[0])[0];
      var akey = Object.keys(d[0])[1];

      // Clear the existing deck and refill it.
      cards = [];
      var q, a;
      for(var n in d) {
        q = d[n][qkey];
        a = d[n][akey];
        cards.push({q:q,a:a});
      }

      // Reset the number of cards remaining to practice
      set_remaining(cards.length);

      // Show the top card
      show_question();
    }

    function flip_cards() {
      reverse = !reverse;
      save_cookie('reverse', reverse);

      var x = select_qvoice.value;
      select_qvoice.value = select_avoice.value;
      select_avoice.value = x;
      
      show_question();
    }

    // Update score
    function set_score(n) {
      score=n;
      document.getElementById('score').innerHTML = 'Score: '+String(n);
    }

    // Update the cards remaining
    function set_remaining(n) {
      if(n == undefined) n = cards.length;
      cards_remaining = n;
      document.getElementById('remaining').innerHTML = 'Remaining: '+String(n);
    }

    // Returns a random integer from m to n
    function random_integer(m,n) { 
        var y = Math.floor(Math.random()*(1+n-m))+m; 

        // exceedingly rare case
        if(y > n) y = n;

        return parseInt(y);
    }
    // randomizes the order of the supplied array (in place)
    function shuffle_array(array) {
      var currentIndex = array.length, temporaryValue, randomIndex ;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        var randomIndex = random_integer(0, currentIndex-1);
        currentIndex -= 1;

        // And swap it with the current element.
        var temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }

    // Shuffles the deck
    function shuffle_cards() { console.log('shuffle_cards()');
      cards = shuffle_array(cards);
      set_score(0);
      show_question();
    }

    function change_qvoice() {
      save_cookie('select_qvoice', select_qvoice.value);
      show_question();
    }
    function change_avoice() {
      save_cookie('select_avoice', select_avoice.value);
      show_answer();
    }

    // Sends the top card to index n. 0 means "bottom", undefined means "random > 2"
    function send_card_to(n,m) { 
      console.log('send_card_to()', n);
      
      // Get the top card
      var top_card = cards.splice(0,1)[0];
      
      // Put it on the bottom of the deck.
      if(n == null) {
        cards.push(top_card);
        set_remaining(cards_remaining-1);
        set_score(score+20);
      }

      // Put it in a random place up to the remaining cards (don't stick it in with the "done" cards)
      else if (n == -1) {
        cards.splice(random_integer(1,cards_remaining-1), 0, top_card);
        set_score(score+10);
      }

      // Put it at location n
      else {
        var x = random_integer(n,m);
        cards.splice(Math.min(x,cards_remaining-1), 0, top_card);
        set_score(score+parseInt(0.5*(n+m)));
      }

      // Show the top card
      show_question();
    }

    // Speaks the supplied div's html in the supplied language
    function speak(qa, lang) {
      if(lang != 'Silent') {
        var utterance = new SpeechSynthesisUtterance();
        utterance.lang = lang;
        //utterance.voice = speechSynthesis.getVoices()[3];
        utterance.text = qa.innerText;
        window.speechSynthesis.speak(utterance);
      }
    }

    // Displays the top card qestion & answer
    function show_question() { console.log('show_question()');
      var q = document.getElementById('div-question');
      var a = document.getElementById('div-answer')  
      
      // If it's zero, we show a special card
      if(cards_remaining<=0) {
        q.innerHTML = 'All done!'
        a.innerHTML = '(tap to begin)'
      }
      
      // Otherwise show the top card
      else if(cards[0]) {
        if(reverse) q.innerHTML = cards[0].a;
        else        q.innerHTML = cards[0].q;
        if(q.innerHTML == '') q.innerHTML = '&nbsp'
        a.innerHTML = '&nbsp'
      }

      // And say it
      speak(q, select_qvoice.value);
    }

    // Show the answer and say it.
    function show_answer() { console.log('show_answer()');
      var q = document.getElementById('div-question');
      var a = document.getElementById('div-answer')  
      
      // Special case, we're done!
      if(cards_remaining<=0) {
        set_remaining(cards.length);
        show_question();
      }

      // Otherwise proceed
      else if(cards[0]) {
        if(reverse) a.innerHTML = cards[0].q;
        else        a.innerHTML = cards[0].a;
        if(a.innerHTML == '') a.innerHTML = '&nbsp';
      }

      // And say it
      speak(a, select_avoice.value);
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>

</body></html>
